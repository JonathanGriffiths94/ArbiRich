{% extends "layouts/base.html" %}

{% block title %}ArbiRich - Exchanges{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-dollar-green">Exchange Management</h1>
    <button id="addExchangeBtn"
        class="bg-dollar-green hover:bg-money-dark text-dark-bg font-bold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center">
        <i class="fas fa-plus mr-2"></i> Add Exchange
    </button>
</div>

<!-- Exchange Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="exchangesList">
    {% for exchange in exchanges %}
    <div class="dashboard-card rounded-lg shadow-md p-6 relative exchange-card" data-id="{{ exchange.id }}">
        <!-- Exchange Status Badge -->
        <div class="absolute top-4 right-4">
            <span
                class="px-2 py-1 rounded-full text-xs font-semibold 
                  {% if exchange.is_active %}bg-green-900 text-profit-green{% else %}bg-gray-800 text-gray-400{% endif %}">
                {{ 'Active' if exchange.is_active else 'Inactive' }}
            </span>
        </div>

        <div class="flex items-center mb-4">
            <div class="bg-dark-element rounded-full p-3 mr-4">
                <i class="fas fa-exchange-alt text-dollar-green text-xl"></i>
            </div>
            <div>
                <h2 class="text-xl font-bold">{{ exchange.name }}</h2>
                <p class="text-text-dim text-sm">{{ exchange.rest_url }}</p>
            </div>
        </div>

        <div class="space-y-3 mb-6">
            <div class="flex justify-between text-sm">
                <span class="text-text-dim">Trade Fee:</span>
                <span>{{ exchange.trade_fees * 100 }}%</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-text-dim">API Rate Limit:</span>
                <span>{{ exchange.api_rate_limit }} req/min</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-text-dim">API Response Time:</span>
                <span>{{ exchange.api_response_time or 0 }}ms</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-text-dim">Delimiter:</span>
                <span>"{{ exchange.delimiter }}"</span>
            </div>
        </div>

        <div class="flex justify-between mt-4">
            <button
                class="edit-exchange-btn bg-dark-element hover:bg-dark-card text-gray-300 py-2 px-3 rounded-lg text-sm transition-colors duration-300"
                data-id="{{ exchange.id }}">
                <i class="fas fa-edit mr-1"></i> Edit
            </button>
            <label class="switch">
                <input type="checkbox" class="exchange-toggle" data-id="{{ exchange.id }}" {% if exchange.is_active
                    %}checked{% endif %}>
                <span class="slider round"></span>
            </label>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Add Exchange Modal -->
<div id="exchangeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-dark-element rounded-lg shadow-lg p-6 w-full max-w-lg">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-dollar-green" id="modalTitle">Add Exchange</h2>
            <button class="text-gray-400 hover:text-gray-200" id="closeModal">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <form id="exchangeForm">
            <input type="hidden" id="exchangeId" value="">

            <div class="mb-4">
                <label class="block text-gray-300 mb-2" for="exchangeName">Exchange Name</label>
                <input
                    class="w-full px-4 py-2 rounded-lg bg-dark-bg border border-gray-700 text-gray-200 focus:border-dollar-green focus:outline-none"
                    type="text" id="exchangeName" name="name" placeholder="e.g., Binance, Kraken" required>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-gray-300 mb-2" for="tradeFee">Trade Fee (%)</label>
                    <input
                        class="w-full px-4 py-2 rounded-lg bg-dark-bg border border-gray-700 text-gray-200 focus:border-dollar-green focus:outline-none"
                        type="number" id="tradeFee" name="trade_fees" step="0.001" min="0" max="100" placeholder="0.1"
                        required>
                </div>
                <div>
                    <label class="block text-gray-300 mb-2" for="rateLimit">Rate Limit (req/min)</label>
                    <input
                        class="w-full px-4 py-2 rounded-lg bg-dark-bg border border-gray-700 text-gray-200 focus:border-dollar-green focus:outline-none"
                        type="number" id="rateLimit" name="api_rate_limit" placeholder="1200" required>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-gray-300 mb-2" for="restUrl">REST API URL</label>
                <input
                    class="w-full px-4 py-2 rounded-lg bg-dark-bg border border-gray-700 text-gray-200 focus:border-dollar-green focus:outline-none"
                    type="url" id="restUrl" name="rest_url" placeholder="https://api.exchange.com" required>
            </div>

            <div class="mb-4">
                <label class="block text-gray-300 mb-2" for="wsUrl">WebSocket URL</label>
                <input
                    class="w-full px-4 py-2 rounded-lg bg-dark-bg border border-gray-700 text-gray-200 focus:border-dollar-green focus:outline-none"
                    type="text" id="wsUrl" name="ws_url" placeholder="wss://stream.exchange.com">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-gray-300 mb-2" for="delimiter">Symbol Delimiter</label>
                    <input
                        class="w-full px-4 py-2 rounded-lg bg-dark-bg border border-gray-700 text-gray-200 focus:border-dollar-green focus:outline-none"
                        type="text" id="delimiter" name="delimiter" placeholder="-">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2" for="responseTime">Avg. Response Time (ms)</label>
                    <input
                        class="w-full px-4 py-2 rounded-lg bg-dark-bg border border-gray-700 text-gray-200 focus:border-dollar-green focus:outline-none"
                        type="number" id="responseTime" name="api_response_time" placeholder="150">
                </div>
            </div>

            <div class="flex items-center mb-6">
                <label class="switch mr-3">
                    <input type="checkbox" id="isActive" name="is_active">
                    <span class="slider round"></span>
                </label>
                <span>Active</span>
            </div>

            <div class="flex justify-end">
                <button type="button" id="cancelBtn"
                    class="bg-dark-bg hover:bg-dark-card text-gray-300 mr-4 py-2 px-6 rounded-lg transition-colors duration-300">
                    Cancel
                </button>
                <button type="submit" id="saveBtn"
                    class="bg-dollar-green hover:bg-money-dark text-dark-bg font-bold py-2 px-6 rounded-lg transition-colors duration-300">
                    Save Exchange
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Success Toast -->
<div id="toast" class="toast hidden">
    <div class="flex items-center">
        <i class="fas fa-check-circle text-profit-green mr-3 text-xl"></i>
        <div>
            <p class="font-medium" id="toastMessage">Exchange updated successfully</p>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // DOM Elements
    const exchangesList = document.getElementById('exchangesList');
    const addExchangeBtn = document.getElementById('addExchangeBtn');
    const exchangeModal = document.getElementById('exchangeModal');
    const closeModal = document.getElementById('closeModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const exchangeForm = document.getElementById('exchangeForm');
    const modalTitle = document.getElementById('modalTitle');
    const exchangeId = document.getElementById('exchangeId');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');

    // Event Listeners
    addExchangeBtn.addEventListener('click', () => openModal());
    closeModal.addEventListener('click', () => closeModalHandler());
    cancelBtn.addEventListener('click', () => closeModalHandler());
    exchangeForm.addEventListener('submit', handleFormSubmit);

    // Setup edit buttons and toggle switches
    document.querySelectorAll('.edit-exchange-btn').forEach(btn => {
        btn.addEventListener('click', () => editExchange(btn.getAttribute('data-id')));
    });

    document.querySelectorAll('.exchange-toggle').forEach(toggle => {
        toggle.addEventListener('change', () => toggleExchange(
            toggle.getAttribute('data-id'),
            toggle.checked
        ));
    });

    // Functions
    function openModal(exchange = null) {
        // Reset form
        exchangeForm.reset();

        if (exchange) {
            // Edit mode
            modalTitle.textContent = 'Edit Exchange';
            exchangeId.value = exchange.id;

            // Fill form fields
            document.getElementById('exchangeName').value = exchange.name;
            document.getElementById('tradeFee').value = exchange.trade_fees * 100; // Convert to percentage
            document.getElementById('rateLimit').value = exchange.api_rate_limit;
            document.getElementById('restUrl').value = exchange.rest_url;
            document.getElementById('wsUrl').value = exchange.ws_url;
            document.getElementById('delimiter').value = exchange.delimiter;
            document.getElementById('responseTime').value = exchange.api_response_time;
            document.getElementById('isActive').checked = exchange.is_active;
        } else {
            // Add mode
            modalTitle.textContent = 'Add Exchange';
            exchangeId.value = '';
        }

        // Show modal
        exchangeModal.classList.remove('hidden');
    }

    function closeModalHandler() {
        exchangeModal.classList.add('hidden');
    }

    async function handleFormSubmit(e) {
        e.preventDefault();

        // Get form data
        const formData = new FormData(exchangeForm);

        // Convert form data to object
        const data = {};
        for (let [key, value] of formData.entries()) {
            // Handle trade_fees as decimal
            if (key === 'trade_fees') {
                data[key] = parseFloat(value) / 100; // Convert percentage to decimal
            } else if (key === 'is_active') {
                data[key] = true; // Checkbox is only included when checked
            } else if (key === 'api_rate_limit' || key === 'api_response_time') {
                data[key] = parseInt(value);
            } else {
                data[key] = value;
            }
        }

        // If is_active wasn't in the form data, it means the checkbox was unchecked
        if (!formData.has('is_active')) {
            data.is_active = false;
        }

        try {
            let url, method, successMessage;

            if (exchangeId.value) {
                // Update existing exchange
                url = `/api/exchanges/${exchangeId.value}`;
                method = 'PUT';
                successMessage = 'Exchange updated successfully';
            } else {
                // Create new exchange
                url = '/api/exchanges';
                method = 'POST';
                successMessage = 'Exchange added successfully';
            }

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error('Failed to save exchange');
            }

            // Close modal
            closeModalHandler();

            // Show success toast
            showToast(successMessage);

            // Reload the page to show the updated list
            setTimeout(() => {
                window.location.reload();
            }, 1000);

        } catch (error) {
            console.error('Error saving exchange:', error);
            showToast('Error: ' + error.message, 'error');
        }
    }

    async function editExchange(id) {
        try {
            const response = await fetch(`/api/exchanges/${id}`);
            if (!response.ok) {
                throw new Error('Failed to fetch exchange data');
            }

            const exchange = await response.json();
            openModal(exchange);

        } catch (error) {
            console.error('Error fetching exchange:', error);
            showToast('Error: ' + error.message, 'error');
        }
    }

    async function toggleExchange(id, isActive) {
        try {
            const response = await fetch(`/api/exchanges/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ is_active: isActive })
            });

            if (!response.ok) {
                throw new Error('Failed to update exchange status');
            }

            showToast(`Exchange ${isActive ? 'activated' : 'deactivated'} successfully`);

        } catch (error) {
            console.error('Error toggling exchange:', error);
            showToast('Error: ' + error.message, 'error');

            // Reset toggle to previous state
            const toggle = document.querySelector(`.exchange-toggle[data-id="${id}"]`);
            if (toggle) {
                toggle.checked = !isActive;
            }
        }
    }

    function showToast(message, type = 'success') {
        toastMessage.textContent = message;

        // Set toast color based on type
        if (type === 'error') {
            toast.style.borderColor = '#e15d5d';
        } else {
            toast.style.borderColor = '#3abe78';
        }

        // Show toast
        toast.classList.remove('hidden');

        // Hide toast after 3 seconds
        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);
    }
</script>
{% endblock %}