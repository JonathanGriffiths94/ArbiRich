{% extends "layouts/base.html" %}

{% block title %}ArbiRich - Trading Strategies{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-dollar-green">Trading Strategies</h1>
    <div class="flex space-x-3">
        <button id="btn-refresh-strategies"
            class="bg-dark-element hover:bg-dark-card text-gray-300 font-semibold py-2 px-4 rounded-lg border border-gray-700 transition-colors duration-300">
            <i class="fas fa-sync-alt mr-2"></i> Refresh
        </button>
        <button id="btn-add-strategy"
            class="bg-dollar-green hover:bg-money-dark text-dark-bg font-bold py-2 px-4 rounded-lg transition-colors duration-300">
            <i class="fas fa-plus mr-2"></i> New Strategy
        </button>
    </div>
</div>

<!-- Strategy Leaderboard -->
<div class="dashboard-card rounded-lg shadow-md p-6 mb-8">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-dollar-green">Strategy Leaderboard</h2>
        <div class="text-sm text-gray-400">Top performers based on profit</div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Top 3 strategies -->
        {% set ranked_strategies = strategies|sort(attribute='profit', reverse=true) %}
        {% set display_count = ranked_strategies|length if ranked_strategies|length < 3 else 3 %} {% for i in
            range(display_count) %} {% set strategy=ranked_strategies[i] %} {% set
            rank_class="bg-yellow-400/20 border-yellow-400" if i==0 else "bg-gray-400/20 border-gray-400" if i==1
            else "bg-amber-700/20 border-amber-700" %} {% set rank_text="ðŸ¥‡ 1st Place" if i==0 else "ðŸ¥ˆ 2nd Place" if
            i==1 else "ðŸ¥‰ 3rd Place" %} <div
            class="bg-dark-card rounded-lg shadow-md p-5 border-l-4 {{ rank_class }} flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <span class="text-sm font-medium text-gray-400">{{ rank_text }}</span>
                    <h3 class="text-lg font-bold text-dollar-green">{{ strategy.name }}</h3>
                </div>
                <div
                    class="px-2 py-1 rounded text-xs font-semibold 
                        {% if strategy.is_running %}bg-blue-900 text-blue-400 flex items-center{% else %}bg-gray-800 text-gray-400{% endif %}">
                    {% if strategy.is_running %}
                    <span class="animate-pulse inline-block h-2 w-2 rounded-full bg-blue-400 mr-1"></span>
                    {% endif %}
                    {{ 'Trading Now' if strategy.is_running else 'Active' if strategy.is_active else 'Inactive' }}
                </div>
            </div>
            <div class="flex justify-between text-sm mb-3">
                <div>
                    <div class="text-text-dim">Win Rate</div>
                    <div class="font-medium text-gray-300">{{ strategy.win_rate|default(0) }}%</div>
                </div>
                <div>
                    <div class="text-text-dim">Trades</div>
                    <div class="font-medium text-gray-300">{{ strategy.trade_count|default(0) }}</div>
                </div>
                <div>
                    <div class="text-text-dim">Profit</div>
                    <div
                        class="font-medium {% if strategy.profit > 0 %}text-profit-green{% else %}text-loss-red{% endif %}">
                        ${{ strategy.profit|default(0)|round(2) }}
                    </div>
                </div>
            </div>
            <div class="mt-auto flex justify-between items-center">
                <a href="/strategy/{{ strategy.name }}"
                    class="text-dollar-green hover:text-money-dark text-sm">Details</a>
                <label class="switch">
                    <input type="checkbox" class="strategy-toggle" data-id="{{ strategy.id }}"
                        data-name="{{ strategy.name }}" {% if strategy.is_active %}checked{% endif %}>
                    <span class="slider round"></span>
                </label>
            </div>
    </div>
    {% endfor %}
</div>
</div>

<!-- Live Strategies Section -->
<div class="dashboard-card rounded-lg shadow-md p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-dollar-green flex items-center">
            <span class="animate-pulse inline-block h-3 w-3 rounded-full bg-blue-400 mr-2"></span>
            Live Trading Strategies
        </h2>
        <div class="text-sm text-gray-400">Actively trading now</div>
    </div>

    {% set live_strategies = [] %}
    {% for strategy in strategies %}
    {% if strategy.is_active and strategy.is_running %}
    {% set _ = live_strategies.append(strategy) %}
    {% endif %}
    {% endfor %}

    {% if live_strategies|length > 0 %}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for strategy in live_strategies %}
        <div class="bg-dark-card rounded-lg p-4 border-l-4 border-blue-400">
            <div class="flex justify-between items-start mb-3">
                <h3 class="font-bold text-dollar-green">{{ strategy.name|default('Unknown') }}</h3>
                <span class="text-xs px-2 py-1 rounded-full bg-blue-900 text-blue-400 flex items-center">
                    <span class="animate-pulse inline-block h-2 w-2 rounded-full bg-blue-400 mr-1"></span>
                    Trading Now
                </span>
            </div>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-text-dim">Win Rate:</span>
                    <span>{{ strategy.win_rate|default(0) }}%</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-text-dim">Trades:</span>
                    <span>{{ strategy.trade_count|default(0) }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-text-dim">Net Profit:</span>
                    <span
                        class="{% if strategy.profit|default(0) > 0 %}text-profit-green{% else %}text-loss-red{% endif %}">
                        ${{ strategy.profit|default(0)|round(2) }}
                    </span>
                </div>
            </div>
            <div class="mt-4 flex justify-between items-center">
                <a href="/strategy/{{ strategy.name }}"
                    class="text-dollar-green hover:text-money-dark text-sm">Details</a>
                <label class="switch">
                    <input type="checkbox" class="strategy-toggle" data-id="{{ strategy.id }}"
                        data-name="{{ strategy.name }}" {% if strategy.is_active %}checked{% endif %}>
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-dark-card rounded-lg p-6 text-center">
        <i class="fas fa-info-circle text-text-dim text-2xl mb-3"></i>
        <p class="text-text-dim">No strategies are currently live trading</p>
    </div>
    {% endif %}
</div>

<!-- Active Strategies Section -->
<div class="dashboard-card rounded-lg shadow-md p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-dollar-green">Active Strategies</h2>
        <div class="text-sm text-gray-400">Ready to trade when conditions are met</div>
    </div>

    {% set active_non_trading_strategies = [] %}
    {% for strategy in strategies %}
    {% if strategy.is_active and not strategy.is_running %}
    {% set _ = active_non_trading_strategies.append(strategy) %}
    {% endif %}
    {% endfor %}

    {% if active_non_trading_strategies|length > 0 %}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for strategy in active_non_trading_strategies %}
        <div class="bg-dark-card rounded-lg p-4 border-l-4 border-profit-green">
            <div class="flex justify-between items-start mb-3">
                <h3 class="font-bold text-dollar-green">{{ strategy.name|default('Unknown') }}</h3>
                <span class="text-xs px-2 py-1 rounded-full bg-green-900 text-profit-green">Active</span>
            </div>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-text-dim">Win Rate:</span>
                    <span>{{ strategy.win_rate|default(0) }}%</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-text-dim">Trades:</span>
                    <span>{{ strategy.trade_count|default(0) }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-text-dim">Net Profit:</span>
                    <span
                        class="{% if strategy.profit|default(0) > 0 %}text-profit-green{% else %}text-loss-red{% endif %}">
                        ${{ strategy.profit|default(0)|round(2) }}
                    </span>
                </div>
            </div>
            <div class="mt-4 flex justify-between items-center">
                <a href="/strategy/{{ strategy.name }}"
                    class="text-dollar-green hover:text-money-dark text-sm">Details</a>
                <label class="switch">
                    <input type="checkbox" class="strategy-toggle" data-id="{{ strategy.id }}"
                        data-name="{{ strategy.name }}" {% if strategy.is_active %}checked{% endif %}>
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-dark-card rounded-lg p-6 text-center">
        <i class="fas fa-info-circle text-text-dim text-2xl mb-3"></i>
        <p class="text-text-dim">No active strategies that aren't currently trading</p>
    </div>
    {% endif %}
</div>

<!-- Inactive Strategies Section -->
<div class="dashboard-card rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-text-dim">Inactive Strategies</h2>
        <div class="text-sm text-gray-400">Disabled strategies</div>
    </div>

    {% set inactive_strategies = [] %}
    {% for strategy in strategies %}
    {% if not strategy.is_active %}
    {% set _ = inactive_strategies.append(strategy) %}
    {% endif %}
    {% endfor %}

    {% if inactive_strategies|length > 0 %}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for strategy in inactive_strategies %}
        <div class="bg-dark-card rounded-lg p-4 border-l-4 border-gray-700 opacity-80">
            <div class="flex justify-between items-start mb-3">
                <h3 class="font-bold text-gray-400">{{ strategy.name|default('Unknown') }}</h3>
                <span class="text-xs px-2 py-1 rounded-full bg-gray-800 text-gray-400">Inactive</span>
            </div>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-text-dim">Win Rate:</span>
                    <span class="text-gray-400">{{ strategy.win_rate|default(0) }}%</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-text-dim">Trades:</span>
                    <span class="text-gray-400">{{ strategy.trade_count|default(0) }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-text-dim">Net Profit:</span>
                    <span class="text-gray-400">
                        ${{ strategy.profit|default(0)|round(2) }}
                    </span>
                </div>
            </div>
            <div class="mt-4 flex justify-between items-center">
                <a href="/strategy/{{ strategy.name }}"
                    class="text-gray-400 hover:text-dollar-green text-sm">Details</a>
                <label class="switch">
                    <input type="checkbox" class="strategy-toggle" data-id="{{ strategy.id }}"
                        data-name="{{ strategy.name }}" {% if strategy.is_active %}checked{% endif %}>
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-dark-card rounded-lg p-6 text-center">
        <i class="fas fa-info-circle text-text-dim text-2xl mb-3"></i>
        <p class="text-text-dim">No inactive strategies</p>
    </div>
    {% endif %}
</div>

<!-- Strategy Toggle JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const toggles = document.querySelectorAll('.strategy-toggle');

        toggles.forEach(toggle => {
            toggle.addEventListener('change', function () {
                const strategyId = this.dataset.id;
                const strategyName = this.dataset.name;
                const isActive = this.checked;

                // Call API to update strategy status
                const endpoint = isActive ?
                    `/api/strategies/${strategyName}/start` :
                    `/api/strategies/${strategyName}/stop`;

                fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to update strategy status');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(`Strategy ${strategyName} ${isActive ? 'activated' : 'deactivated'} successfully`);

                        // Show success message
                        showNotification(`Strategy ${isActive ? 'activated' : 'deactivated'} successfully`, 'success');

                        // Refresh the page after a short delay to show updated status
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    })
                    .catch(error => {
                        console.error('Error updating strategy status:', error);

                        // Revert toggle state
                        this.checked = !isActive;

                        // Show error message
                        showNotification('Error updating strategy status', 'error');
                    });
            });
        });

        // Refresh button
        document.getElementById('btn-refresh-strategies').addEventListener('click', function () {
            window.location.reload();
        });

        // New strategy button
        document.getElementById('btn-add-strategy').addEventListener('click', function () {
            window.location.href = '/strategy/new';
        });

        // Notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-opacity duration-300 ${type === 'error' ? 'bg-loss-red/90 text-white' :
                type === 'success' ? 'bg-profit-green/90 text-white' :
                    'bg-dark-element text-white'
                }`;

            notification.innerHTML = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
    });
</script>
{% endblock %}