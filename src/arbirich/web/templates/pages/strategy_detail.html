{% extends "layouts/base.html" %}

{% block title %}
    ArbiRich - {{ strategy.name }} Details
{% endblock %}

{% block content %}
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-lime-green">
            Strategy: {{ strategy.name }}
        </h1>
        <div class="flex space-x-3">
            <!-- Toggle switch -->
            <div class="flex items-center">
                <label for="strategy-toggle" class="flex items-center cursor-pointer">
                    <div class="relative">
                        <input type="checkbox" id="strategy-toggle" class="sr-only" {{ 'checked' if strategy.is_active }}>
                        <div class="w-14 h-7 bg-dark-element rounded-full shadow-inner"></div>
                        <div class="dot absolute w-5 h-5 bg-gray-400 rounded-full shadow left-1 top-1 transition-transform duration-300 {{ 'transform translate-x-7 bg-profit-green' if strategy.is_active }}"></div>
                    </div>
                    <div class="ml-2 text-gray-200">
                        <span id="toggle-status" class="{{ 'text-profit-green' if strategy.is_active else 'text-gray-400' }}">
                            {{ 'Active' if strategy.is_active else 'Inactive' }}
                        </span>
                    </div>
                </label>
            </div>
            <!-- Navigation links -->
            <a href="/strategies/{{ strategy.id }}/metrics" class="bg-dark-element hover:bg-dark-card text-dollar-green py-2 px-4 rounded-lg transition-colors duration-300 flex items-center">
                <i class="fas fa-chart-bar mr-2"></i> View Metrics
            </a>
            <a href="/strategies/{{ strategy.id }}" class="bg-dark-element hover:bg-dark-card text-dollar-green py-2 px-4 rounded-lg transition-colors duration-300 flex items-center">
                <i class="fas fa-info-circle mr-2"></i> Overview
            </a>
            <a href="/strategies" class="bg-dark-element hover:bg-dark-card text-dollar-green py-2 px-4 rounded-lg transition-colors duration-300">
                <i class="fas fa-list mr-2"></i> All Strategies
            </a>
        </div>
    </div>

    <!-- Strategy Overview Card -->
    <div class="dashboard-card rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-bold text-dollar-green mb-4">
            Strategy Overview
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-dark-element p-4 rounded-lg">
                <p class="text-gray-400 text-sm">
                    Starting Capital
                </p>
                <p class="text-xl font-semibold">
                    ${{ strategy.starting_capital | round(2) }}
                </p>
            </div>
            <div class="bg-dark-element p-4 rounded-lg">
                <p class="text-gray-400 text-sm">
                    Net Profit
                </p>
                <p class="text-xl font-semibold {% if strategy.net_profit > 0 %}text-profit-green{% else %}text-loss-red{% endif %}">
                    ${{ strategy.net_profit | round(2) }}
                </p>
            </div>
            <div class="bg-dark-element p-4 rounded-lg">
                <p class="text-gray-400 text-sm">
                    ROI
                </p>
                <p class="text-xl font-semibold {% if strategy.net_profit > 0 %}text-profit-green{% else %}text-loss-red{% endif %}">
                    {{ ((strategy.net_profit / strategy.starting_capital) * 100) | round(2) }}%
                </p>
            </div>
            <div class="bg-dark-element p-4 rounded-lg">
                <p class="text-gray-400 text-sm">
                    Trade Count
                </p>
                <p class="text-xl font-semibold">
                    {{ strategy.trade_count }}
                </p>
            </div>
        </div>
    </div>

    <!-- Performance Metrics -->
    {% if metrics %}
        <div class="dashboard-card rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold text-dollar-green mb-4">
                Performance Metrics
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="bg-dark-element p-4 rounded-lg">
                    <p class="text-gray-400 text-sm">
                        Win Rate
                    </p>
                    <p class="text-xl font-semibold">
                        {{ metrics.win_rate | round(2) }}%
                    </p>
                    <p class="text-gray-400 text-xs">
                        Wins: {{ metrics.win_count }} / Losses: {{ metrics.loss_count }}
                    </p>
                </div>
                <div class="bg-dark-element p-4 rounded-lg">
                    <p class="text-gray-400 text-sm">
                        Profit Factor
                    </p>
                    <p class="text-xl font-semibold">
                        {{ metrics.profit_factor | round(2) }}
                    </p>
                    <p class="text-gray-400 text-xs">
                        Gross Profit รท Gross Loss
                    </p>
                </div>
                <div class="bg-dark-element p-4 rounded-lg">
                    <p class="text-gray-400 text-sm">
                        Gross Profit
                    </p>
                    <p class="text-xl font-semibold text-profit-green">
                        ${{ metrics.gross_profit | round(2) }}
                    </p>
                </div>
                <div class="bg-dark-element p-4 rounded-lg">
                    <p class="text-gray-400 text-sm">
                        Gross Loss
                    </p>
                    <p class="text-xl font-semibold text-loss-red">
                        ${{ metrics.gross_loss | round(2) }}
                    </p>
                </div>
                <div class="bg-dark-element p-4 rounded-lg">
                    <p class="text-gray-400 text-sm">
                        Average Profit per Trade
                    </p>
                    <p class="text-xl font-semibold text-profit-green">
                        ${{ metrics.avg_profit_per_trade | round(2) }}
                    </p>
                </div>
                <div class="bg-dark-element p-4 rounded-lg">
                    <p class="text-gray-400 text-sm">
                        Average Loss per Trade
                    </p>
                    <p class="text-xl font-semibold text-loss-red">
                        ${{ metrics.avg_loss_per_trade | round(2) }}
                    </p>
                </div>
                <div class="bg-dark-element p-4 rounded-lg">
                    <p class="text-gray-400 text-sm">
                        Max Drawdown
                    </p>
                    <p class="text-xl font-semibold text-loss-red">
                        ${{ metrics.max_drawdown | round(2) }}
                    </p>
                    <p class="text-gray-400 text-xs">
                        {{ metrics.max_drawdown_percentage | round(2) }}%
                    </p>
                </div>
                <div class="bg-dark-element p-4 rounded-lg">
                    <p class="text-gray-400 text-sm">
                        Risk Reward Ratio
                    </p>
                    <p class="text-xl font-semibold">
                        {{ metrics.risk_reward_ratio | round(2) }}
                    </p>
                    <p class="text-gray-400 text-xs">
                        Average Profit รท Average Loss
                    </p>
                </div>
                <div class="bg-dark-element p-4 rounded-lg">
                    <p class="text-gray-400 text-sm">
                        Average Hold Time
                    </p>
                    <p class="text-xl font-semibold">
                        {% if metrics.avg_hold_time_seconds > 3600 %}
                            {{ (metrics.avg_hold_time_seconds / 3600) | round(2) }} hours
                        {% elif metrics.avg_hold_time_seconds > 60 %}
                            {{ (metrics.avg_hold_time_seconds / 60) | round(2) }} mins
                        {% else %}
                            {{ metrics.avg_hold_time_seconds | round(0) }} secs
                        {% endif %}
                    </p>
                </div>
                <div class="bg-dark-element p-4 rounded-lg">
                    <p class="text-gray-400 text-sm">
                        Total Volume
                    </p>
                    <p class="text-xl font-semibold">
                        {{ metrics.total_volume | round(4) }}
                    </p>
                </div>
                <div class="bg-dark-element p-4 rounded-lg">
                    <p class="text-gray-400 text-sm">
                        Average Volume per Trade
                    </p>
                    <p class="text-xl font-semibold">
                        {{ metrics.avg_volume_per_trade | round(4) }}
                    </p>
                </div>
                <div class="bg-dark-element p-4 rounded-lg">
                    <p class="text-gray-400 text-sm">
                        Analysis Period
                    </p>
                    <p class="text-xl font-semibold">
                        {{ metrics.period_start.strftime("%Y-%m-%d") }} to {{ metrics.period_end.strftime("%Y-%m-%d") }}
                    </p>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Trading Pair Metrics -->
    {% if pair_metrics %}
        <div class="dashboard-card rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold text-dollar-green mb-4">
                Trading Pair Performance
            </h2>
            <div class="overflow-x-auto">
                <table class="w-full table-auto">
                    <thead class="bg-dark-element">
                        <tr>
                            <th class="px-4 py-2 text-left text-dollar-green">
                                Trading Pair
                            </th>
                            <th class="px-4 py-2 text-left text-dollar-green">
                                Trade Count
                            </th>
                            <th class="px-4 py-2 text-left text-dollar-green">
                                Net Profit
                            </th>
                            <th class="px-4 py-2 text-left text-dollar-green">
                                Win Rate
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pair_metric in pair_metrics %}
                            <tr class="border-t border-dark-element hover:bg-dark-element">
                                <td class="px-4 py-2 font-medium">
                                    {{ pair_metric.trading_pair.symbol }}
                                </td>
                                <td class="px-4 py-2">
                                    {{ pair_metric.trade_count }}
                                </td>
                                <td class="px-4 py-2 {% if pair_metric.net_profit > 0 %}text-profit-green{% else %}text-loss-red{% endif %}">
                                    ${{ pair_metric.net_profit | round(2) }}
                                </td>
                                <td class="px-4 py-2">
                                    {{ pair_metric.win_rate | round(2) }}%
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}

    <!-- Exchange Metrics -->
    {% if exchange_metrics %}
        <div class="dashboard-card rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold text-dollar-green mb-4">
                Exchange Performance
            </h2>
            <div class="overflow-x-auto">
                <table class="w-full table-auto">
                    <thead class="bg-dark-element">
                        <tr>
                            <th class="px-4 py-2 text-left text-dollar-green">
                                Exchange
                            </th>
                            <th class="px-4 py-2 text-left text-dollar-green">
                                Trade Count
                            </th>
                            <th class="px-4 py-2 text-left text-dollar-green">
                                Net Profit
                            </th>
                            <th class="px-4 py-2 text-left text-dollar-green">
                                Win Rate
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for exchange_metric in exchange_metrics %}
                            <tr class="border-t border-dark-element hover:bg-dark-element">
                                <td class="px-4 py-2 font-medium">
                                    {{ exchange_metric.exchange.name }}
                                </td>
                                <td class="px-4 py-2">
                                    {{ exchange_metric.trade_count }}
                                </td>
                                <td class="px-4 py-2 {% if exchange_metric.net_profit > 0 %}text-profit-green{% else %}text-loss-red{% endif %}">
                                    ${{ exchange_metric.net_profit | round(2) }}
                                </td>
                                <td class="px-4 py-2">
                                    {{ exchange_metric.win_rate | round(2) }}%
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}

    <!-- Recent Executions/Trades -->
    <div class="dashboard-card rounded-lg shadow-md p-6">
        <h2 class="text-xl font-bold text-dollar-green mb-4">
            Recent Trades
        </h2>
        {% if executions %}
            <div class="overflow-x-auto">
                <table class="w-full table-auto">
                    <thead class="bg-dark-element">
                        <tr>
                            <th class="px-4 py-2 text-left text-dollar-green">
                                Trading Pair
                            </th>
                            <th class="px-4 py-2 text-left text-dollar-green">
                                Buy Exchange
                            </th>
                            <th class="px-4 py-2 text-left text-dollar-green">
                                Sell Exchange
                            </th>
                            <th class="px-4 py-2 text-left text-dollar-green">
                                Buy Price
                            </th>
                            <th class="px-4 py-2 text-left text-dollar-green">
                                Sell Price
                            </th>
                            <th class="px-4 py-2 text-left text-dollar-green">
                                Profit
                            </th>
                            <th class="px-4 py-2 text-left text-dollar-green">
                                Volume
                            </th>
                            <th class="px-4 py-2 text-left text-dollar-green">
                                Date
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for execution in executions %}
                            <tr class="border-t border-dark-element hover:bg-dark-element">
                                <td class="px-4 py-2 font-medium">
                                    {{ execution.pair }}
                                </td>
                                <td class="px-4 py-2">
                                    {{ execution.buy_exchange }}
                                </td>
                                <td class="px-4 py-2">
                                    {{ execution.sell_exchange }}
                                </td>
                                <td class="px-4 py-2">
                                    ${{ execution.executed_buy_price | round(4) }}
                                </td>
                                <td class="px-4 py-2">
                                    ${{ execution.executed_sell_price | round(4) }}
                                </td>
                                <td class="px-4 py-2 {% if (execution.executed_sell_price - execution.executed_buy_price) > 0 %}text-profit-green{% else %}text-loss-red{% endif %}">
                                    ${{ ((execution.executed_sell_price - execution.executed_buy_price) * execution.volume) | round(2) }}
                                </td>
                                <td class="px-4 py-2">
                                    {{ execution.volume | round(4) }}
                                </td>
                                <td class="px-4 py-2 text-gray-300">
                                    {{ execution.execution_timestamp.strftime("%Y-%m-%d %H:%M") }}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-gray-400">
                No trade executions found for this strategy.
            </p>
        {% endif %}
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const strategyToggle = document.getElementById('strategy-toggle');
            const toggleStatus = document.getElementById('toggle-status');
            const strategyName = '{{ strategy.name }}';

            if (strategyToggle) {
                strategyToggle.addEventListener('change', function() {
                    const isActive = this.checked;
                    if (isActive) {
                        activateStrategy(strategyName);
                    } else {
                        deactivateStrategy(strategyName);
                    }
                });
            }

            function activateStrategy(name) {
                fetch(`/api/strategies/${name}/activate`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Strategy activated:', data);
                    showNotification('Strategy activated successfully. All required exchanges and pairs are now active.', 'success');
                    // Update the UI without refreshing
                    updateToggleUI(true);
                    
                    // Refresh after 1.5 seconds to get updated data
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                })
                .catch(error => {
                    console.error('Error activating strategy:', error);
                    showNotification('Failed to activate strategy: ' + error.message, 'error');
                    // Reset toggle to previous state
                    strategyToggle.checked = false;
                    updateToggleUI(false);
                });
            }
            
            function deactivateStrategy(name) {
                fetch(`/api/strategies/${name}/deactivate`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Strategy deactivated:', data);
                    showNotification('Strategy deactivated successfully. Unused exchanges and pairs have been deactivated.', 'success');
                    
                    // Update the UI without refreshing
                    updateToggleUI(false);
                    
                    // Refresh after 1.5 seconds to get updated data
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                })
                .catch(error => {
                    console.error('Error deactivating strategy:', error);
                    showNotification('Failed to deactivate strategy: ' + error.message, 'error');
                    // Reset toggle to previous state
                    strategyToggle.checked = true;
                    updateToggleUI(true);
                });
            }
            
            function updateToggleUI(active) {
                const dot = strategyToggle.nextElementSibling.nextElementSibling;
                if (active) {
                    dot.classList.add('transform', 'translate-x-7', 'bg-profit-green');
                    dot.classList.remove('bg-gray-400');
                    toggleStatus.textContent = 'Active';
                    toggleStatus.classList.add('text-profit-green');
                    toggleStatus.classList.remove('text-gray-400');
                } else {
                    dot.classList.remove('transform', 'translate-x-7', 'bg-profit-green');
                    dot.classList.add('bg-gray-400');
                    toggleStatus.textContent = 'Inactive';
                    toggleStatus.classList.remove('text-profit-green');
                    toggleStatus.classList.add('text-gray-400');
                }
            }

            // Notification function
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-opacity duration-300 ${
                    type === 'success' ? 'bg-profit-green/90 text-white' :
                    type === 'error' ? 'bg-loss-red/90 text-white' :
                    'bg-dark-element text-white'
                }`;
                notification.innerHTML = message;
                document.body.appendChild(notification);
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }
        });
    </script>
{% endblock %}
