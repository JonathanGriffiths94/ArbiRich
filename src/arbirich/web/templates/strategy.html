{% extends "base.html" %}

{% block title %}ArbiRich - {{ strategy.name }} Strategy{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-dollar-green">{{ strategy.name }} Strategy</h1>
    <div class="flex items-center">
        <span class="text-sm text-gray-500 mr-3">Auto-updating every 30s</span>
        <span class="refresh-indicator" id="refresh-indicator"></span>
        <button id="refresh-dashboard" class="ml-3 bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Refresh
        </button>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
    <!-- Strategy Stats Cards -->
    <div
        class="dashboard-card rounded-lg shadow-md p-6 border border-dark-element hover:border-dollar-green transition-colors duration-300">
        <h2 class="text-xl font-bold text-dollar-green mb-4">Performance Metrics</h2>
        <div class="mt-4 space-y-3">
            <div class="flex justify-between">
                <span class="text-gray-400">Starting Capital:</span>
                <span class="font-semibold">${{ strategy.starting_capital }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-400">Total Profit:</span>
                <span class="font-semibold text-profit-green">${{ strategy.total_profit | round(2) }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-400">Total Loss:</span>
                <span class="font-semibold text-loss-red">${{ strategy.total_loss | round(2) }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-400">Net Profit:</span>
                <span
                    class="font-semibold {% if strategy.net_profit > 0 %}text-profit-green{% else %}text-loss-red{% endif %}">
                    ${{ strategy.net_profit | round(2) }}
                </span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-400">Min Spread:</span>
                <span class="font-semibold">{{ (strategy.min_spread * 100) | round(4) }}%</span>
            </div>
        </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md dashboard-card">
        <h2 class="text-xl font-bold text-green-700">Trade Statistics</h2>
        <div class="mt-4 space-y-3">
            <div class="flex justify-between">
                <span class="text-gray-600">Total Trades:</span>
                <span class="font-semibold">{{ strategy.trade_count }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">Success Rate:</span>
                <span class="font-semibold">
                    {% if strategy.trade_count > 0 %}
                    {% set success_rate = ((strategy.total_profit / (strategy.total_profit + strategy.total_loss)) *
                    100) | round(1) %}
                    <span class="{% if success_rate > 50 %}text-green-600{% else %}text-red-600{% endif %}">
                        {{ success_rate }}%
                    </span>
                    {% else %}
                    0%
                    {% endif %}
                </span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">ROI:</span>
                <span
                    class="font-semibold {% if strategy.net_profit > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                    {{ ((strategy.net_profit / strategy.starting_capital) * 100) | round(2) }}%
                </span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">Running Since:</span>
                <span class="font-semibold">{{ strategy.start_timestamp.strftime('%Y-%m-%d') }}</span>
            </div>
        </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md dashboard-card">
        <h2 class="text-xl font-bold text-purple-700">Strategy Details</h2>
        <div class="mt-4 space-y-3">
            <div class="flex justify-between">
                <span class="text-gray-600">Type:</span>
                <span class="font-semibold">{{ strategy.additional_info.get('type', 'basic') }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">Pairs:</span>
                <span class="font-semibold">{{ strategy.additional_info.get('pairs', [])|join(', ') }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">Exchanges:</span>
                <span class="font-semibold">{{ strategy.additional_info.get('exchanges', [])|join(', ') }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">Last Updated:</span>
                <span class="font-semibold">{{ strategy.last_updated.strftime('%Y-%m-%d %H:%M:%S') }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Strategy Performance Chart -->
<div class="dashboard-card rounded-lg shadow-md p-4 mb-8">
    <h2 class="text-xl font-bold text-lime-green mb-4">Performance Over Time</h2>
    <div style="height: 300px; position: relative;">
        <canvas id="strategyChart"></canvas>
    </div>
</div>

<!-- Recent Strategy Opportunities -->
<div class="dashboard-card rounded-lg shadow-md p-4 mb-8">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-lime-green">Recent Opportunities</h2>
        <span class="text-sm text-gray-400">Showing latest 10</span>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full table-auto" id="strategyOpportunitiesTable">
            <thead class="bg-dark-element">
                <tr>
                    <th class="px-4 py-2 text-left text-lime-green">ID</th>
                    <th class="px-4 py-2 text-left text-lime-green">Pair</th>
                    <th class="px-4 py-2 text-left text-lime-green">Buy Exchange</th>
                    <th class="px-4 py-2 text-left text-lime-green">Sell Exchange</th>
                    <th class="px-4 py-2 text-left text-lime-green">Buy Price</th>
                    <th class="px-4 py-2 text-left text-lime-green">Sell Price</th>
                    <th class="px-4 py-2 text-left text-lime-green">Profit %</th>
                    <th class="px-4 py-2 text-left text-lime-green">Created At</th>
                </tr>
            </thead>
            <tbody>
                {% for opp in opportunities %}
                <tr class="border-t border-dark-element hover:bg-dark-element">
                    <td class="px-4 py-2 font-mono text-sm">{{ opp.id[:8] }}...</td>
                    <td class="px-4 py-2 font-semibold">{{ opp.pair }}</td>
                    <td class="px-4 py-2">{{ opp.buy_exchange }}</td>
                    <td class="px-4 py-2">{{ opp.sell_exchange }}</td>
                    <td class="px-4 py-2 text-right">{{ opp.buy_price | round(6) }}</td>
                    <td class="px-4 py-2 text-right">{{ opp.sell_price | round(6) }}</td>
                    <td
                        class="px-4 py-2 text-right {% if opp.profit_percent > 0 %}text-profit-green{% else %}text-loss-red{% endif %}">
                        {{ opp.profit_percent | round(4) }}%
                    </td>
                    <td class="px-4 py-2 text-gray-300">{{ opp.created_at.strftime('%Y-%m-%d %H:%M:%S') if
                        opp.created_at else 'N/A' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Recent Strategy Executions -->
<div class="dashboard-card rounded-lg shadow-md p-4">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-lime-green">Recent Executions</h2>
        <span class="text-sm text-gray-400">Showing latest 10</span>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full table-auto" id="strategyExecutionsTable">
            <thead class="bg-dark-element">
                <tr>
                    <th class="px-4 py-2 text-left text-lime-green">ID</th>
                    <th class="px-4 py-2 text-left text-lime-green">Opportunity ID</th>
                    <th class="px-4 py-2 text-left text-lime-green">Pair</th>
                    <th class="px-4 py-2 text-left text-lime-green">Status</th>
                    <th class="px-4 py-2 text-left text-lime-green">Actual Profit</th>
                    <th class="px-4 py-2 text-left text-lime-green">Timestamp</th>
                </tr>
            </thead>
            <tbody>
                {% for exec in executions %}
                <tr class="border-t border-dark-element hover:bg-dark-element">
                    <td class="px-4 py-2 font-mono text-sm">{{ exec.id[:8] }}...</td>
                    <td class="px-4 py-2 font-mono text-sm">
                        {% if exec.opportunity_id and exec.opportunity_id != "None" %}
                        {{ exec.opportunity_id[:8] }}...
                        {% else %}
                        N/A
                        {% endif %}
                    </td>
                    <td class="px-4 py-2 font-semibold">{{ exec.pair }}</td>
                    <td class="px-4 py-2">
                        <span class="px-2 py-1 rounded-full text-xs font-semibold
                        {% if exec.status == 'completed' %}
                            bg-green-900 text-lime-green
                        {% elif exec.status == 'failed' %}
                            bg-red-900 text-loss-red
                        {% else %}
                            bg-yellow-900 text-yellow-300
                        {% endif %}">
                            {{ exec.status }}
                        </span>
                    </td>
                    <td
                        class="px-4 py-2 text-right {% if exec.actual_profit > 0 %}text-profit-green{% else %}text-loss-red{% endif %}">
                        {{ exec.actual_profit | round(4) }}
                    </td>
                    <td class="px-4 py-2 text-gray-300">{{ exec.created_at.strftime('%Y-%m-%d %H:%M:%S') if
                        exec.created_at else 'N/A' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Setup strategy performance chart
    const ctx = document.getElementById('strategyChart').getContext('2d');

    // Mock historical data - this would be replaced with real data from backend
    const dates = [];
    const netProfitData = [];
    const totalProfitData = [];
    const totalLossData = [];

    // Generate dates for the last 30 days
    const now = new Date();
    for (let i = 30; i >= 0; i--) {
        const date = new Date(now);
        date.setDate(date.getDate() - i);
        dates.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
    }

    // In a real implementation, this would use backend data
    // For now, generate some example data
    let netProfit = 0;
    let totalProfit = 0;
    let totalLoss = 0;

    for (let i = 0; i <= 30; i++) {
        const dailyProfit = Math.random() * 300 - 100;

        if (dailyProfit > 0) {
            totalProfit += dailyProfit;
        } else {
            totalLoss += Math.abs(dailyProfit);
        }

        netProfit += dailyProfit;

        netProfitData.push(netProfit);
        totalProfitData.push(totalProfit);
        totalLossData.push(-totalLoss);
    }

    // Create chart
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [
                {
                    label: 'Net Profit',
                    data: netProfitData,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.1,
                    borderWidth: 2,
                    pointRadius: 2,
                },
                {
                    label: 'Total Profit',
                    data: totalProfitData,
                    borderColor: 'rgb(16, 185, 129)',
                    backgroundColor: 'rgba(16, 185, 129, 0.05)',
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.1,
                    borderWidth: 1.5,
                    pointRadius: 0,
                },
                {
                    label: 'Total Loss',
                    data: totalLossData,
                    borderColor: 'rgb(239, 68, 68)',
                    backgroundColor: 'rgba(239, 68, 68, 0.05)',
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.1,
                    borderWidth: 1.5,
                    pointRadius: 0,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    grid: {
                        display: false
                    }
                },
                y: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function (value) {
                            return '$' + value.toFixed(2);
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += '$' + context.parsed.y.toFixed(2);
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });

    // Refresh functionality
    document.getElementById('refresh-dashboard').addEventListener('click', function () {
        location.reload();
    });
</script>
{% endblock %}